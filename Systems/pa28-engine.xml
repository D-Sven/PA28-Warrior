<!-- PA28-161 Engine -->

<!-- Copyright (c) 2018 Joshua Davidson (it0uchpods) -->

<system name="PA28-161: Engine">
	
	<channel name="Magnetos-Starter" execrate="8">
		
		<switch name="fcs/magneto-l">
			<default value="0"/>
			<test logic="AND" value="1"> <!-- L -->
				/systems/failures/l-magneto ne 1
				/controls/engines/engine[0]/magnetos-switch eq 2
				/systems/electrical/bus/elec1 ge 8
			</test>
			<test logic="AND" value="1"> <!-- BOTH or START -->
				/systems/failures/l-magneto ne 1
				/controls/engines/engine[0]/magnetos-switch ge 3
				/systems/electrical/bus/elec1 ge 8
			</test>
		</switch>
		
		<switch name="fcs/magneto-r">
			<default value="0"/>
			<test logic="AND" value="1"> <!-- R -->
				/systems/failures/r-magneto ne 1
				/controls/engines/engine[0]/magnetos-switch eq 1
				/systems/electrical/bus/elec2 ge 8
			</test>
			<test logic="AND" value="1"> <!-- BOTH or START -->
				/systems/failures/r-magneto ne 1
				/controls/engines/engine[0]/magnetos-switch ge 3
				/systems/electrical/bus/elec2 ge 8
			</test>
		</switch>
		
		<switch name="fcs/magneto-final">
			<default value="0"/>
			<test logic="AND" value="3"> <!-- BOTH -->
				fcs/magneto-l eq 1
				fcs/magneto-r eq 1
			</test>
			<test logic="AND" value="2"> <!-- R -->
				fcs/magneto-l ne 1
				fcs/magneto-r eq 1
			</test>
			<test logic="AND" value="1"> <!-- L -->
				fcs/magneto-l eq 1
				fcs/magneto-r ne 1
			</test>
			<output>/controls/engines/engine[0]/magnetos</output>
		</switch>
		
		<switch name="fcs/start-switch">
			<default value="0"/>
			<test logic="AND" value="1">
				fcs/magneto-l eq 1
				/controls/engines/engine[0]/magnetos-switch eq 4
			</test>
			<test logic="AND" value="1">
				fcs/magneto-r eq 1
				/controls/engines/engine[0]/magnetos-switch eq 4
			</test>
		</switch>
	
	</channel>
	
	<channel name="Engine">
		
		<lag_filter name="fcs/throttle-cmd-lag">
			<input>/controls/engines/engine[0]/throttle</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="fcs/carb-heat-lever">
			<input>/controls/anti-ice/engine[0]/carb-heat-cmd</input>
			<c1>20</c1>
			<output>/controls/anti-ice/engine[0]/carb-heat</output>
		</lag_filter>
		
		<fcs_function name="fcs/throttle-cmd-modified">
			<function>
				<difference>
					<table>
						<independentVar lookup="row">fcs/throttle-cmd-lag</independentVar>
						<independentVar lookup="column">velocities/vc-kts</independentVar>
						<tableData>
								 30    60    120   180
							0.0  0.04  0.04  0.04  0.04
							0.2  0.42  0.37  0.34  0.32
							0.6  0.74  0.66  0.60  0.56
							1.0  1.00  0.89  0.82  0.76
						</tableData>
					</table>
					<product> <!-- Reduces RPM with carb heat on -->
						<property>fcs/carb-heat-lever</property>
						<value>0.04</value>
					</product>
				</difference>
			</function>
			<output>fcs/throttle-cmd-norm[0]</output>
			<output>fcs/throttle-pos-norm[0]</output>
			<clipto>
				<min>0.0</min>
				<max>1.0</max>
			</clipto>
		</fcs_function>
		
		<lag_filter name="fcs/mixture-cmd-lag">
			<input>/controls/engines/engine[0]/mixture</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="fcs/mixture-cmd-modified">
			<function>
				<table>
					<independentVar lookup="row">fcs/mixture-cmd-lag</independentVar>
					<independentVar lookup="column">atmosphere/pressure-altitude</independentVar>
					<tableData>
						   0     15000
						0  0.55  0.25
						1  1.00  1.00
					</tableData>
				</table>
			</function>
			<output>fcs/mixture-cmd-norm[0]</output>
			<output>fcs/mixture-pos-norm[0]</output>
		</fcs_function>
		
		<fcs_function name="fcs/oil-temp-inc">
			<function>
				<sum>
					<property>fcs/oil-temp-feedback</property>
					<value>0.03</value>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fcs/oil-temp-dec">
			<function>
				<difference>
					<property>fcs/oil-temp-feedback</property>
					<value>0.01</value>
				</difference>
			</function>
		</fcs_function>
		
		<switch name="fcs/oil-temp-switch">
			<default value="fcs/oil-temp-switch"/>
			<test logic="AND" value="fcs/oil-temp-inc">
				/engines/engine[0]/running eq 1
				fcs/oil-temp-feedback lt 177
			</test>
			<test logic="AND" value="fcs/oil-temp-dec">
				/engines/engine[0]/running ne 1
				fcs/oil-temp-feedback gt 0
			</test>
		</switch>
		
		<pure_gain name="fcs/oil-temp-update">
			<input>fcs/oil-temp-switch</input>
			<gain>1.0</gain>
			<output>fcs/oil-temp-feedback</output>
		</pure_gain>
		
		<fcs_function name="fcs/egt-inc">
			<function>
				<sum>
					<property>fcs/egt-feedback</property>
					<value>0.4</value>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fcs/egt-dec">
			<function>
				<difference>
					<property>fcs/egt-feedback</property>
					<value>0.1</value>
				</difference>
			</function>
		</fcs_function>
		
		<switch name="fcs/egt-switch">
			<default value="fcs/egt-switch"/>
			<test logic="AND" value="fcs/egt-inc">
				/engines/engine[0]/running eq 1
				fcs/egt-feedback lt 1028
			</test>
			<test logic="AND" value="fcs/egt-dec">
				/engines/engine[0]/running ne 1
				fcs/egt-feedback gt 0
			</test>
		</switch>
		
		<pure_gain name="fcs/egt-update">
			<input>fcs/egt-switch</input>
			<gain>1.0</gain>
			<output>fcs/egt-feedback</output>
		</pure_gain>
	
	</channel>

</system>
